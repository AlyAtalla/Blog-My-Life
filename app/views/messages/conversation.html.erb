<div class="row">
  <div class="col-md-8">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Conversation with <%= link_to @other.name, @other %></h3>
      <div>
        <%= link_to 'Back to Inbox', messages_path, class: 'btn btn-sm btn-outline-secondary' %>
      </div>
    </div>

    <div id="conversation" style="max-height:60vh;overflow:auto;padding:8px;border:1px solid #e9ecef;border-radius:6px;">
      <% @messages.each do |m| %>
        <%= render partial: 'message', locals: { message: m } %>
      <% end %>
    </div>

    <div class="mt-3">
      <%= form_with model: @message, url: messages_path, local: true do |f| %>
        <%= hidden_field_tag 'message[recipient_id]', @other.id %>
        <div class="mb-2">
          <%= f.text_area :body, rows: 4, class: 'form-control', placeholder: 'Write your message...' %>
        </div>
        <div>
          <%= f.submit 'Send', class: 'btn btn-primary' %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="col-md-4">
    <h5>Participant</h5>
    <div class="card p-3">
      <div class="text-center">
        <% if @other.avatar_url.present? %>
          <%= image_tag @other.avatar_url, style: 'width:96px;height:96px;object-fit:cover;border-radius:50%;' %>
        <% else %>
          <%= image_tag 'https://placehold.co/96x96/png?text=Avatar', style: 'width:96px;height:96px;object-fit:cover;border-radius:50%;' %>
        <% end %>
      </div>
      <h5 class="mt-2 text-center"><%= @other.name %></h5>
      <p class="text-muted text-center"><%= @other.email %></p>
      <% if @other.bio.present? %>
        <div><strong>About</strong>
        <p><%= simple_format(@other.bio) %></p></div>
      <% end %>
      <div class="mt-2 text-center">
        <%= link_to 'View Profile', @other, class: 'btn btn-sm btn-outline-primary' %>
        <%= link_to 'Message', new_message_path(recipient_id: @other.id), class: 'btn btn-sm btn-primary ms-2' %>
      </div>
    </div>
  </div>
</div>
<% content_for :title, "Conversation with #{@other.name}" %>

<h3>Conversation with <%= @other.name %></h3>

<div class="mb-3">
  <% @messages.each do |m| %>
    <div class="mb-2">
      <div class="small text-muted"><strong><%= m.sender == current_user ? 'You' : m.sender.name %></strong> â€¢ <%= time_ago_in_words(m.created_at) %> ago</div>
      <div class="p-2" style="background:#f5f5f5;border-radius:.375rem;margin-top:.25rem;max-width:80%;">
        <%= simple_format(h(m.body)) %>
      </div>
    </div>
  <% end %>
</div>

<div class="card p-3">
  <%= form_with model: @message, url: messages_path, local: true do |f| %>
    <%= hidden_field_tag 'message[recipient_id]', @other.id %>
    <div class="mb-2">
      <%= f.text_area :body, class: 'form-control', rows: 3, placeholder: 'Write your message...' %>
    </div>
    <div class="d-flex gap-2">
      <%= f.submit 'Send', class: 'btn btn-primary' %>
      <%= link_to 'Back to inbox', messages_path, class: 'btn btn-outline-secondary' %>
    </div>
  <% end %>
</div>
